<!DOCTYPE html>
<html>
<body>
    <img id="streaming"/>
    <script>
        var ws = new WebSocket('ws://localhost:8999');

        ws.binaryType = 'arraybuffer';                                  // 받는 데터 형식을 arraybuffer로 설정

        var currentBlobUrl = null;                                      // 현재 Blob URL 저장
        var streamingImage = document.querySelector('#streaming');

        ws.onmessage = function (event){
            // 기존에 생성된 Blob URL이 있다면 해제
            if(currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
            }
            
            // 서버로부터 받은 데이터를 blob 객체로 변환, 이를 이미지로 표시
            var blob = new Blob([event.data], {type: 'image/jpeg'});
            currentBlobUrl = URL.createObjectURL(blob);
            streamingImage.src = currentBlobUrl;
        };

        ws.onopen = function(event) {
            console.log('Connected to WebSocket server');
        };

        ws.onerror = function(error) {
            console.log('WebSocket error: ' + error);
        };

        ws.onclose = function(event) {
            if(event.wasClean){
                console.log('Connection closed clearly, code=${event.code} reason=${event.reason}');
            } else {
                console.log('Connection died');
            }
        };

        window.addEventListener('beforeunload', function() {
            if(ws) {
                ws.close();
            }
            if(currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
            }
        })
    </script>
</body>
</html>
